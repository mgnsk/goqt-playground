options:
  user:
    default:
      command: id -un
  group:
    default:
      command: id -gn
  uid:
    default:
      command: id -u
  gid:
    default:
      command: id -g
  docker_gid:
    default:
      # TODO
      command: echo 65535

tasks:
  sandbox.build:
    usage: Build docker images.
    run:
      - command: >
          docker-compose build
          --build-arg USER=${user}
          --build-arg GROUP=${group}
          --build-arg UID=${uid}
          --build-arg GID=${gid}
          --build-arg DOCKER_GID=${docker_gid}
      - command: docker image prune -f

  sandbox.up:
    usage: Start all containers.
    run:
      - command: mkdir -p qt
      - command: docker-compose up -d

  sandbox.bash:
    usage: Enter a sandbox shell.
    run:
      - command: docker-compose exec go /bin/bash

  sandbox.qtsetup:
    usage: Download and install the QT framework.
    description: If you run go mod vendor again you have to run qtsetup again.
    run:
      - command: >
          [ -z "$(ls -A ./qt)" ] && git clone https://github.com/therecipe/env_linux_amd64_513.git qt || true
      - command: docker-compose exec sandbox go get -v github.com/therecipe/qt
      - command: docker-compose exec sandbox go install -v -tags=no_env github.com/therecipe/qt/cmd/...
      - command: docker-compose exec sandbox go mod download
      - command: docker-compose exec sandbox go mod vendor
      - command: docker-compose exec sandbox ln -s /qt /app/vendor/github.com/therecipe/env_linux_amd64_513
      - command: docker-compose exec sandbox qtsetup
